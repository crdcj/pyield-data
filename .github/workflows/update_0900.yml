name: Atualiza칞칚o Proje칞칚o Infla칞칚o (Artifact-Based)

on:
  schedule:
    - cron: "00 12 * * 1-5" # 12:00 UTC = 09:00 BRT
  workflow_dispatch:

jobs:
  update-datasets:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Essencial para baixar e criar releases

    steps:
      - name: Check out repository
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"
    
      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Install required locales
        run: |
          sudo apt-get update
          sudo apt-get install -y locales
          sudo locale-gen pt_BR.UTF-8
          sudo update-locale

      - name: Download data from Latest Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "游닌 Baixando arquivos do 칰ltimo release para atualiza칞칚o..."
          mkdir -p data
          # Baixa tudo o que estiver no release atual para a pasta data/
          gh release download --pattern "*" --dir data || echo "丘멆잺 Nenhum release encontrado."
          ls -R data/

      - name: Run update script
        run: python update_0900.py

      - name: Set Date Tags
        id: dates
        run: |
          export TZ="America/Sao_Paulo"
          echo "date_tag=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "date_br=$(date +'%d-%m-%Y')" >> $GITHUB_OUTPUT

      - name: Create/Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="data-${{ steps.dates.outputs.date_tag }}"
          
          # Se o Job de madrugada j치 criou o release de hoje, 
          # o comando abaixo apenas atualiza os arquivos (faz o upload por cima).
          # Se n칚o existir, ele cria um novo.
          
          echo "游 Atualizando release $TAG com novos dados de infla칞칚o..."
          
          # O comando 'gh release create' com files e sem 'delete' 
          # pode falhar se a tag j치 existir, ent칚o usamos 'upload' se existir
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release upload "$TAG" data/* --clobber
          else
            gh release create "$TAG" data/* \
              --title "Dados ${{ steps.dates.outputs.date_br }}" \
              --notes "Atualiza칞칚o autom치tica de infla칞칚o e datasets." \
              --latest
          fi

      - name: Delete old releases (Keep last 30)
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 100 --json tagName --jq '.[] | .tagName' | \
          tail -n +31 | \
          xargs -I {} gh release delete {} --yes