name: AtualizaÃ§Ã£o DI e Anbima

on:
  schedule:
    - cron: "30 00 * * 2-6" # Executa Ã s 00:30 de terÃ§a a sÃ¡bado
    - cron: "30 10 * * 2-6" # Executa Ã s 10:30 de terÃ§a a sÃ¡bado (backup)
  workflow_dispatch:

jobs:
  update-datasets:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # NecessÃ¡rio para criar releases
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"
    
      - name: Install dependencies
        run: pip install -r requirements.txt
    
      - name: Run update script
        run: python update.py

      - name: Check for changes
        id: check_changes
        run: |
          if [[ $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "date_tag=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
            echo "date_br=$(date +'%d-%m-%Y')" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "cr.cj@outlook.com"
          git config --local user.name "Carlos Carvalho"          
          git add data/*.parquet
          git commit -m "Dados atualizados em [${{ steps.check_changes.outputs.date_br }}]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release with datasets
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: data-${{ steps.check_changes.outputs.date_tag }}
          name: Dados ${{ steps.check_changes.outputs.date_br }}
          body: |
            ## ðŸ“Š AtualizaÃ§Ã£o DiÃ¡ria de Dados
            
            **Data de referÃªncia:** ${{ steps.check_changes.outputs.date_br }}
            
            ### Arquivos disponÃ­veis:
            - `b3_di.parquet` - Contratos futuros DI1 da B3
            - `anbima_tpf.parquet` - TÃ­tulos PÃºblicos Federais (Anbima)
            
            ### Como usar:
            ```python
            # URL sempre aponta para a versÃ£o mais recente
            url = "https://github.com/crdcj/pyield-data/releases/latest/download/b3_di.parquet"
            df = pl.read_parquet(url)
            ```
          files: |
            data/b3_di.parquet
            data/anbima_tpf.parquet
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}