name: Atualiza√ß√£o DI e Anbima

on:
  schedule:
    - cron: "30 00 * * 2-6" # 21:30 BRT
    - cron: "25 09 * * 2-6"   # 02:30 BRT
  workflow_dispatch:
    inputs:
      force_release:
        description: 'For√ßar cria√ß√£o do Release?'
        required: false
        default: true
        type: boolean

jobs:
  update-datasets:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.14"
    
      - name: Install dependencies
        run: pip install -r requirements.txt
    
      - name: Run update script with retry
        run: |
          max_attempts=3
          retry_wait=1800  # 30 minutos
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "üîÑ Tentativa $attempt de $max_attempts..."
            
            if timeout 15m python update.py; then
              echo "‚úÖ Script executado com sucesso!"
              exit 0
            else
              if [ $attempt -lt $max_attempts ]; then
                echo "‚è≥ Tentativa $attempt falhou, aguardando 30 minutos para nova tentativa..."
                sleep $retry_wait
              else
                echo "‚ùå Todas as tentativas falharam"
                exit 1
              fi
            fi
            
            attempt=$((attempt + 1))
          done

      - name: Check for changes
        id: check_changes
        run: |
          # 1. Gera as datas SEMPRE, independente de ter mudan√ßa
          echo "date_tag=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "date_br=$(date +'%d-%m-%Y')" >> $GITHUB_OUTPUT
          
          # 2. Verifica o git status
          if [[ $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Mudan√ßas detectadas pelo Git."
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "Nenhuma mudan√ßa de arquivo detectada."
          fi

      - name: Commit and push changes
        # S√≥ executa o commit se o GIT detectou mudan√ßas reais
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "cr.cj@outlook.com"
          git config --local user.name "Carlos Carvalho"          
          git add data/*.parquet
          git commit -m "Dados atualizados em [${{ steps.check_changes.outputs.date_br }}]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release with datasets
        # Executa se tiver mudan√ßas OU se foi disparado manualmente com a flag 'force_release'
        if: steps.check_changes.outputs.has_changes == 'true' || inputs.force_release == true
        run: |
          TAG="data-${{ steps.check_changes.outputs.date_tag }}"
          
          echo "Gerando release para tag: $TAG"
          
          # Se for execu√ß√£o manual for√ßada, deletamos a tag/release anterior do dia para recriar
          if [[ "${{ inputs.force_release }}" == "true" ]]; then
             gh release delete "$TAG" --yes || true
             git tag -d "$TAG" || true
             # Aguarda um pouco para o GitHub processar a dele√ß√£o
             sleep 5 
             # Puxa as tags remotas atualizadas para garantir que n√£o haja conflito local
             git fetch --tags || true
          fi

          gh release create "$TAG" \
            data/b3_di.parquet \
            data/anbima_tpf.parquet \
            --title "Dados ${{ steps.check_changes.outputs.date_br }}" \
            --notes "Atualiza√ß√£o di√°ria - Dados de ${{ steps.check_changes.outputs.date_br }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old releases
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          gh release list --limit 100 --json tagName --jq '.[] | .tagName' | \
          tail -n +31 | \
          xargs -I {} gh release delete {} --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}